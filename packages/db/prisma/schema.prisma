// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- GLOBAL (Cross-Tenant) ---

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  fullName      String
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenants       TenantUser[]
}

// --- TENANT SCOPED ---

model Tenant {
  id            String    @id @default(uuid())
  name          String
  slug          String    @unique
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())

  users         TenantUser[]
  sites         Site[]
  patients      Patient[]
  specialties   Specialty[]
  schedule      Appointment[]
  medicalNotes  MedicalNote[]
  invoices      Invoice[]
  priceVersions AppointmentPriceVersion[]
  collections   AppointmentCollection[]
  landingPage   LandingPage?
  
  config        Json? 
}

enum Role {
  ADMIN
  RECEPTIONIST
  COORDINATOR
  PROFESSIONAL
  PATIENT
}

model TenantUser {
  id            String    @id @default(uuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  role          Role

  professionalData Professional?

  @@unique([tenantId, userId])
}

model Site {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  address     String?
  phone       String?
  active      Boolean  @default(true)
  
  boxes       Box[]
  appointments Appointment[]
}

model Box {
  id          String   @id @default(uuid())
  siteId      String
  site        Site     @relation(fields: [siteId], references: [id])
  name        String
  active      Boolean  @default(true)
  
  appointments Appointment[]
}

model Specialty {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  
  professionals Professional[]
}

model Professional {
  id            String      @id @default(uuid())
  tenantUserId  String      @unique
  tenantUser    TenantUser  @relation(fields: [tenantUserId], references: [id])
  
  specialtyId   String
  specialty     Specialty   @relation(fields: [specialtyId], references: [id])
  
  licenseNumber String?
  color         String?
  active        Boolean     @default(true)

  appointments  Appointment[]
  medicalNotes  MedicalNote[] // Notas que escribi√≥
}

model Patient {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  firstName     String
  lastName      String
  dni           String
  birthDate     DateTime?
  email         String?
  phone         String?
  address       String?
  gender        String?
  
  healthInsurance String?
  affiliateNumber String?

  notes         String?

  createdAt     DateTime @default(now())
  
  appointments  Appointment[]
  medicalRecord MedicalNote[]
  invoices      Invoice[]
  
  @@unique([tenantId, dni])
}

enum AppointmentStatus {
  RESERVED
  CONFIRMED
  ATTENDED
  ABSENT
  CANCELLED
}

enum CollectionStatus {
  PENDING
  PAID
  OVERDUE
}

enum AppointmentType {
  REGULAR
  EVALUATION
}

model Appointment {
  id              String            @id @default(uuid())
  tenantId        String
  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  
  siteId          String
  site            Site              @relation(fields: [siteId], references: [id])
  
  boxId           String?
  box             Box?              @relation(fields: [boxId], references: [id])
  
  professionalId  String
  professional    Professional      @relation(fields: [professionalId], references: [id])
  
  patientId       String
  patient         Patient           @relation(fields: [patientId], references: [id])
  
  startTime       DateTime
  endTime         DateTime
  
  type            AppointmentType
  status          AppointmentStatus @default(RESERVED)
  
  notes           String?
  
  priceArsInt     Int?
  priceVersionId  String?
  priceVersion    AppointmentPriceVersion? @relation(fields: [priceVersionId], references: [id])
  collection      AppointmentCollection?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([tenantId, professionalId, startTime, endTime])
  @@index([tenantId, boxId, startTime, endTime])
}

model MedicalNote {
  id              String        @id @default(uuid())
  tenantId        String
  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  
  patientId       String
  patient         Patient       @relation(fields: [patientId], references: [id])
  
  authorId        String // Professional ID de quien escribe
  author          Professional  @relation(fields: [authorId], references: [id])
  
  content         String
  date            DateTime      @default(now())
  
  attachments     Attachment[]
}

model Attachment {
  id              String      @id @default(uuid())
  medicalNoteId   String
  medicalNote     MedicalNote @relation(fields: [medicalNoteId], references: [id])
  
  url             String
  filename        String
  mimeType        String
  size            Int
}

model Invoice {
  id              String      @id @default(uuid())
  tenantId        String
  tenant          Tenant      @relation(fields: [tenantId], references: [id])
  
  patientId       String
  patient         Patient     @relation(fields: [patientId], references: [id])
  
  amount          Decimal
  concept         String
  status          String      // PENDING, PAID, CANCELLED
  paymentMethod   String?
  
  createdAt       DateTime    @default(now())
}

model AppointmentPriceVersion {
  id                String      @id @default(uuid())
  tenantId          String
  tenant            Tenant      @relation(fields: [tenantId], references: [id])
  priceArsInt       Int
  effectiveFrom     DateTime    @default(now())
  createdByUserId   String
  createdAt         DateTime    @default(now())
  isActive          Boolean     @default(true)
  
  appointments      Appointment[]
}

model AppointmentCollection {
  id                String            @id @default(uuid())
  appointmentId     String            @unique
  appointment       Appointment       @relation(fields: [appointmentId], references: [id])
  tenantId          String
  tenant            Tenant            @relation(fields: [tenantId], references: [id])
  amountDueArsInt   Int
  dueDate           DateTime
  status            CollectionStatus  @default(PENDING)
  paidAt            DateTime?
  notes             String?
  updatedAt         DateTime          @default(now()) @updatedAt
  updatedByUserId   String?
}

model LandingPage {
  id               String   @id @default(uuid())
  tenantId         String   @unique
  tenant           Tenant   @relation(fields: [tenantId], references: [id])

  enabled          Boolean  @default(false)
  slug             String   @unique

  headline         String?
  subheadline      String?
  heroImageUrl     String?
  logoUrl          String?

  primaryCtaText   String?
  primaryCtaLink   String?

  sections         Json?
  contact          Json?
  theme            Json?
  seo              Json?

  poweredByEnabled Boolean  @default(true)

  updatedAt        DateTime @updatedAt
  updatedByUserId  String?
}
